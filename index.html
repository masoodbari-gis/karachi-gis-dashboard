<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Karachi GIS Dashboard â€“ Masood Bari</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Bootstrap & jQuery -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; }
.sidebar { padding:10px; overflow-y:auto; height:100vh; }
</style>
</head>

<body>

<div class="container-fluid">
<div class="row">

<!-- SIDEBAR -->
<div class="col-md-3 sidebar">

<h4 class="text-center">Karachi GIS Dashboard</h4>
<hr>

<b>Search Road Name</b>
<input id="txtRoad" class="form-control" placeholder="e.g. Shahrah-e-Faisal">
<br>
<button id="btnRoad" class="btn btn-primary btn-block">Search Road</button>
<hr>

<b>Maximum Speed</b>
<select id="selSpeed" class="form-control">
  <option value="">Select Speed</option>
  <option value="ALL">Remove Filter</option>
  <option>40</option><option>60</option><option>80</option>
  <option>100</option><option>110</option><option>120</option>
</select>
<br>
<button id="btnSpeed" class="btn btn-warning btn-block">Filter Speed</button>
<hr>

<b>Road Class</b>
<select id="selClass" class="form-control">
  <option value="">Select Class</option>
  <option value="ALL">Remove Filter</option>
  <option>primary</option>
  <option>secondary</option>
  <option>tertiary</option>
  <option>trunk</option>
  <option>residential</option>
</select>
<br>
<button id="btnClass" class="btn btn-success btn-block">Filter Class</button>
<hr>

<b>Water Name</b>
<select id="selWater" class="form-control"></select>
<br>
<button id="btnWater" class="btn btn-info btn-block">Filter Water</button>
<hr>

<b>Pakistan District</b>
<select id="selDistrict" class="form-control"></select>
<br>
<button id="btnDistrict" class="btn btn-danger btn-block">Filter District</button>

<hr>
<h4>Road Length Summary</h4>
<canvas id="roadChart"></canvas>

</div>

<!-- MAP -->
<div class="col-md-9">
<div id="map"></div>
</div>

</div>
</div>

<script>
// ================= MAP =================
var map = L.map('map').setView([24.86, 67.01], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// ================= GLOBAL =================
var roadLayer, waterLayer, districtLayer, roadChart;
var roadData = { type:"FeatureCollection", features:[] };
var waterData, districtData;

// ================= HELPERS =================
function clearOverlays(){
  if(waterLayer) map.removeLayer(waterLayer);
  if(districtLayer) map.removeLayer(districtLayer);
}

function showRoads(data){
  if(roadLayer) map.removeLayer(roadLayer);

  roadLayer = L.geoJSON(data,{
    style:{ color:"#3366cc", weight:2 }
  }).addTo(map);

  drawRoadChart(data.features);
}

function drawRoadChart(features){
  let summary = {};

  features.forEach(f=>{
    let name = f.properties.name || "Unnamed";
    let len  = f.properties.Shape_Leng || 0;
    summary[name] = (summary[name] || 0) + len;
  });

  let labels = Object.keys(summary).slice(0,10);
  let values = labels.map(l=>summary[l]);

  if(roadChart) roadChart.destroy();

  roadChart = new Chart(
    document.getElementById("roadChart"),
    {
      type:"bar",
      data:{
        labels:labels,
        datasets:[{ label:"Road Length", data:values }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:false} }
      }
    }
  );
}

// ================= LOAD ROADS =================
function loadRoads(url){
  $.getJSON(url,function(d){
    roadData.features.push(...d.features);
    showRoads(roadData);
  });
}

loadRoads("khi_east.geojson");
loadRoads("khi_west.geojson");
loadRoads("khi_south.geojson");
loadRoads("khi_central.geojson");

// ================= WATER =================
$.getJSON("khi_water.geojson",function(data){
  waterData = data;
  $("#selWater").html('<option value="">Select Water</option><option value="ALL">Remove Filter</option>');
  [...new Set(data.features.map(f=>f.properties.name).filter(Boolean))]
    .sort().forEach(w=>$("#selWater").append(`<option>${w}</option>`));
});

// ================= DISTRICT =================
$.getJSON("Pak_Admin.geojson",function(data){
  districtData = data;
  $("#selDistrict").html('<option value="">Select District</option><option value="ALL">Remove Filter</option>');
  [...new Set(data.features.map(f=>f.properties.NAME_3).filter(Boolean))]
    .sort().forEach(d=>$("#selDistrict").append(`<option>${d}</option>`));
});

// ================= FILTERS =================
$("#btnRoad").click(()=>{
  let r = $("#txtRoad").val().toLowerCase();
  if(!r) return;
  clearOverlays();

  let res = roadData.features.filter(f =>
    f.properties.name && f.properties.name.toLowerCase().includes(r)
  );

  showRoads({ type:"FeatureCollection", features:res });
  if(res.length) map.fitBounds(L.geoJSON(res).getBounds());
});

$("#btnSpeed").click(()=>{
  let s=$("#selSpeed").val();
  clearOverlays();
  if(!s || s==="ALL"){ showRoads(roadData); return; }

  showRoads({
    type:"FeatureCollection",
    features: roadData.features.filter(f =>
      f.properties.maxspeed && f.properties.maxspeed.toString().includes(s)
    )
  });
});

$("#btnClass").click(()=>{
  let c=$("#selClass").val();
  clearOverlays();
  if(!c || c==="ALL"){ showRoads(roadData); return; }

  showRoads({
    type:"FeatureCollection",
    features: roadData.features.filter(f => f.properties.fclass===c)
  });
});

$("#btnWater").click(()=>{
  let w=$("#selWater").val();
  clearOverlays();
  if(!w || w==="ALL") return;

  waterLayer = L.geoJSON(waterData,{
    filter:f=>f.properties.name===w,
    style:{ color:"blue", weight:2 }
  }).addTo(map);

  map.fitBounds(waterLayer.getBounds());
});

$("#btnDistrict").click(()=>{
  let d=$("#selDistrict").val();
  clearOverlays();
  if(!d || d==="ALL") return;

  districtLayer = L.geoJSON(districtData,{
    filter:f=>f.properties.NAME_3===d,
    style:{
      color:"red",
      weight:3,
      fillColor:"#ff6666",
      fillOpacity:0.4
    }
  }).addTo(map);

  districtLayer.bringToFront();
  map.fitBounds(districtLayer.getBounds());
});
</script>

</body>
</html>
