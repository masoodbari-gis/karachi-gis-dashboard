<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Karachi GIS Dashboard design by MB</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
html, body { height:100%; margin:0; }
#map { height:100vh; }
.sidebar { padding:10px; }
</style>
</head>

<body>

<div class="container-fluid">
<div class="row">

<!-- SIDEBAR -->
<div class="col-md-3 sidebar">

<h4 class="text-center">Locate</h4>

<!-- OSM -->
<input id="txtOSM" class="form-control" placeholder="Enter OSM ID">
<br>
<button id="btnOSM" class="btn btn-primary btn-block">Find Road</button>
<hr>

<!-- SPEED -->
<b>Karachi Roads Maximum Speed Filter:</b>
<select id="selSpeed" class="form-control">
  <option value="">Select Speed</option>
  <option value="ALL">Remove Filter</option>
  <option>40</option>
  <option>60</option>
  <option>80</option>
  <option>100</option>
  <option>110</option>
  <option>120</option>
  <option>200</option>
</select>
<br>
<button id="btnSpeed" class="btn btn-warning btn-block">Filter</button>
<hr>

<!-- CLASS -->
<b>Road Classification:</b>
<select id="selClass" class="form-control">
  <option value="">Select Class</option>
  <option value="ALL">Remove Filter</option>
  <option>primary</option>
  <option>secondary</option>
  <option>tertiary</option>
  <option>trunk</option>
  <option>residential</option>
</select>
<br>
<button id="btnClass" class="btn btn-success btn-block">Filter</button>
<hr>

<!-- WATER -->
<b>Pakistan River Feature Name</b>
<select id="selWater" class="form-control">
  <option value="">Select Water Name</option>
  <option value="ALL">Remove Filter</option>
</select>
<br>
<button id="btnWater" class="btn btn-info btn-block">Find</button>
<hr>

<!-- DISTRICT -->
<b>Pakistan District</b>
<select id="selDistrict" class="form-control">
  <option value="">Select District</option>
  <option value="ALL">Remove Filter</option>
</select>
<br>
<button id="btnDistrict" class="btn btn-danger btn-block">Filter District</button>

</div>

<!-- MAP -->
<div class="col-md-9">
<div id="map"></div>
</div>

</div>
</div>

<script>
// ================= MAP =================
var map = L.map('map').setView([24.86, 67.01], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

// ================= GLOBAL =================
var roadLayer, waterLayer, districtLayer;
var roadData={type:"FeatureCollection",features:[]};
var waterData, districtData;
var DISTRICT_FIELD=null;

// ================= HELPERS =================
function popupContent(f){
  let h="";
  for(let k in f.properties){
    h+=`<b>${k}</b>: ${f.properties[k]}<br>`;
  }
  return h;
}

function resetLayers(){
  if(roadLayer) map.removeLayer(roadLayer);
  if(waterLayer) map.removeLayer(waterLayer);
  if(districtLayer) map.removeLayer(districtLayer);
}

function showAllRoads(){
  resetLayers();
  roadLayer=L.geoJSON(roadData,{
    style:{color:"#3366cc",weight:2},
    onEachFeature:(f,l)=>l.bindPopup(popupContent(f))
  }).addTo(map);
}

// ðŸ”´ FIXED SPEED PARSER (MULTI-VALUE)
function speedMatch(val, target){
  if(!val) return false;
  let nums = val.toString().match(/\d+/g);
  return nums ? nums.includes(target) : false;
}

// ================= LOAD ROADS =================
function loadRoads(url){
  $.getJSON(url,function(d){
    roadData.features.push(...d.features);
    showAllRoads();
  });
}

loadRoads("data/data/khi_east.geojson");
loadRoads("data/data/khi_west.geojson");
loadRoads("data/data/khi_south.geojson");
loadRoads("data/data/khi_central.geojson");

// ================= WATER =================
$.getJSON("data/data/khi_water.geojson",function(d){
  waterData=d;

  [...new Set(d.features.map(f=>f.properties.name).filter(Boolean))]
    .forEach(n=>$("#selWater").append(`<option>${n}</option>`));

  waterLayer=L.geoJSON(d,{
    style:{color:"blue"}
  }).addTo(map);
});

// ================= DISTRICTS =================
$.getJSON("data/data/Pak_Admin.geojson",function(d){
  districtData=d;
  let p=Object.keys(d.features[0].properties);
  DISTRICT_FIELD=p.find(x=>x.toLowerCase().includes("dist")||x.toLowerCase().includes("name_3")||x.toLowerCase().includes("adm3"));

  [...new Set(d.features.map(f=>f.properties[DISTRICT_FIELD]).filter(Boolean))]
    .sort()
    .forEach(n=>$("#selDistrict").append(`<option>${n}</option>`));
});

// ================= FILTER EVENTS =================

// SPEED
$("#btnSpeed").click(()=>{
  let s=$("#selSpeed").val();
  if(!s) return;
  if(s==="ALL"){ showAllRoads(); return; }

  resetLayers();
  roadLayer=L.geoJSON(roadData,{
    filter:f=>speedMatch(f.properties.maxspeed,s),
    style:{color:"orange",weight:3}
  }).addTo(map);
});

// CLASS
$("#btnClass").click(()=>{
  let c=$("#selClass").val();
  if(!c) return;
  if(c==="ALL"){ showAllRoads(); return; }

  resetLayers();
  roadLayer=L.geoJSON(roadData,{
    filter:f=>f.properties.fclass===c,
    style:{color:"green",weight:3}
  }).addTo(map);
});

// WATER
$("#btnWater").click(()=>{
  let w=$("#selWater").val();
  if(!w) return;
  if(w==="ALL"){ showAllRoads(); return; }

  resetLayers();
  waterLayer=L.geoJSON(waterData,{
    filter:f=>f.properties.name===w,
    style:{color:"blue",weight:3}
  }).addTo(map);
});

// DISTRICT
$("#btnDistrict").click(()=>{
  let d=$("#selDistrict").val();
  if(!d) return;
  if(d==="ALL"){ showAllRoads(); return; }

  resetLayers();
  districtLayer=L.geoJSON(districtData,{
    filter:f=>f.properties[DISTRICT_FIELD]===d,
    style:{color:"red",weight:3,fillOpacity:0.25}
  }).addTo(map);

  map.fitBounds(districtLayer.getBounds());
});
</script>

</body>
</html>
